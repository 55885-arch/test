<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>

<style>
body{
    font-family:Arial;
    background:#f4f4f4;
    margin:0;
    padding:20px;
}

h2{
    margin-top:0;
}

.box{
    background:white;
    padding:20px;
    margin-bottom:20px;
    border-radius:10px;
    box-shadow:0 2px 5px rgba(0,0,0,0.1);
}

input,select{
    padding:8px;
    margin:5px 0;
    width:100%;
}

button{
    padding:8px 15px;
    margin-top:10px;
    cursor:pointer;
}

.card{
    border:1px solid #ccc;
    padding:10px;
    margin:10px 0;
}
</style>
</head>

<body>

<h2>üîí Admin Panel</h2>

<div class="box">
    <h3>GitHub Token</h3>
    <input type="password" id="tokenInput" placeholder="‡πÉ‡∏™‡πà GitHub Token">
    <button onclick="saveToken()">Save Token</button>
    <button onclick="clearToken()">Clear Token</button>
    <p id="tokenStatus"></p>
</div>

<div class="box">
    <h3>‡πÄ‡∏û‡∏¥‡πà‡∏° / ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç Card</h3>

    <input id="title" placeholder="‡∏´‡∏±‡∏ßÔøΩÔøΩ‡πâ‡∏≠">
    <input id="description" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î">
    <input id="file" placeholder="‡πÑ‡∏ü‡∏•‡πå ‡πÄ‡∏ä‡πà‡∏ô FilesFolder/test.pdf">

    <select id="subject">
        <option>‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
        <option>‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
        <option>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
        <option>‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</option>
    </select>

    <select id="subsubject">
        <option>-</option>
        <option>‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
        <option>‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå</option>
        <option>‡πÄ‡∏Ñ‡∏°‡∏µ</option>
        <option>‡∏ä‡∏µ‡∏ß‡∏∞</option>
    </select>

    <select id="grade">
        <option>‡∏°.1</option>
        <option>‡∏°.2</option>
        <option>‡∏°.3</option>
        <option>‡∏°.4</option>
        <option>‡∏°.5</option>
        <option>‡∏°.6</option>
    </select>

    <button onclick="addCard()">Add Card</button>
    <button onclick="uploadData()">Save to GitHub</button>
</div>

<div class="box">
    <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Card</h3>
    <div id="cardList"></div>
</div>

<script>
const owner = "55885-arch"
const repo = "test"
const path = "data.json"

let cards = []
let sha = ""

function saveToken(){
    const token = document.getElementById("tokenInput").value
    localStorage.setItem("githubToken", token)
    document.getElementById("tokenStatus").innerText="Token saved"
}

function clearToken(){
    localStorage.removeItem("githubToken")
    document.getElementById("tokenStatus").innerText="Token cleared"
}

async function loadData(){
    try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`)
        
        if (!res.ok) {
            console.error("Failed to load data:", res.status, res.statusText)
            return
        }

        const data = await res.json()
        sha = data.sha
        const content = atob(data.content)
        cards = JSON.parse(content)
        render()
    } catch (error) {
        console.error("Error loading data:", error)
    }
}

function render(){
    const list = document.getElementById("cardList")
    list.innerHTML=""

    cards.forEach((c,i)=>{
        list.innerHTML+=`
        <div class="card">
            <b>${c.title}</b><br>
            ${c.description || ''}<br>
            ${c.subject} - ${c.category || c.subsubject || ''} - ${c.grade}<br>
            <button onclick="deleteCard(${i})">Delete</button>
        </div>
        `
    })
}

function addCard(){
    const newCard={
        title:document.getElementById("title").value,
        description:document.getElementById("description").value,
        file:document.getElementById("file").value,
        subject:document.getElementById("subject").value,
        category:document.getElementById("subsubject").value,
        grade:document.getElementById("grade").value
    }

    cards.push(newCard)
    render()
}

function deleteCard(i){
    cards.splice(i,1)
    render()
}

async function uploadData(){
    const token = localStorage.getItem("githubToken")
    if(!token){
        alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà token ‡∏Å‡πà‡∏≠‡∏ô")
        return
    }

    // ‚úÖ IMPORTANT: Refresh SHA before uploading
    try {
        const refreshRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`)
        const refreshData = await refreshRes.json()
        sha = refreshData.sha
        console.log("Updated SHA:", sha)
    } catch (error) {
        console.error("Failed to refresh SHA:", error)
        alert("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï SHA ‡πÑ‡∏î‡πâ")
        return
    }

    const content = btoa(JSON.stringify(cards, null, 2))

    try {
        const res = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
            method: "PUT",
            headers: {
                Authorization: `token ${token}`,
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                message: "update data.json",
                content: content,
                sha: sha
            })
        })

        if (!res.ok) {
            const errorData = await res.json()
            console.error("API Error:", errorData)
            alert("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + (errorData.message || "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡πÑ‡∏î‡πâ"))
            return
        }

        alert("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à")
        await loadData()
    } catch (error) {
        console.error("Upload error:", error)
        alert("‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: " + error.message)
    }
}

loadData()
</script>

</body>
</html>
