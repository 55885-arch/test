<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>
<style>
body{font-family:Arial;background:#f4f4f4;padding:20px}
input,select,button{padding:6px;margin:4px}
.card{background:#fff;padding:10px;margin:8px 0;border-radius:8px}
</style>
</head>
<body>

<h2>Admin Panel</h2>

<input type="password" id="token" placeholder="GitHub Token">

<h3>เพิ่ม / แก้ไข Card</h3>

<input type="hidden" id="cardId">

<input id="title" placeholder="ชื่อเรื่อง">

<select id="subject">
<option>วิทยาศาสตร์</option>
<option>คณิตศาสตร์</option>
<option>ภาษาไทย</option>
</select>

<select id="category">
<option>วิทยาศาสตร์พื้นฐาน</option>
<option>ฟิสิกส์</option>
<option>เคมี</option>
<option>ชีวะ</option>
</select>

<select id="grade">
<option>ม.1</option>
<option>ม.2</option>
<option>ม.3</option>
<option>ม.4</option>
<option>ม.5</option>
<option>ม.6</option>
</select>

<input id="file" placeholder="FilesFolder/xxx.pdf">

<br>
<button onclick="saveCard()">บันทึก</button>

<hr>

<h3>รายการ Card</h3>
<div id="list"></div>

<script>

const repo = "55885-arch/test";
const dataPath = "data.json";

let allData = [];
let sha = "";

async function loadData(){
    const res = await fetch(`https://api.github.com/repos/${repo}/contents/${dataPath}`);
    const data = await res.json();
    sha = data.sha;
    const decoded = atob(data.content);
    allData = JSON.parse(decoded);
    renderList();
}

function renderList(){
    const list = document.getElementById("list");
    list.innerHTML = "";
    allData.forEach(item=>{
        list.innerHTML += `
        <div class="card">
            <b>${item.title}</b>
            <br>${item.subject} / ${item.category} / ${item.grade}
            <br>
            <button onclick="editCard(${item.id})">แก้ไข</button>
            <button onclick="deleteCard(${item.id})">ลบ</button>
        </div>
        `;
    });
}

function editCard(id){
    const item = allData.find(i=>i.id===id);
    document.getElementById("cardId").value = item.id;
    document.getElementById("title").value = item.title;
    document.getElementById("subject").value = item.subject;
    document.getElementById("category").value = item.category;
    document.getElementById("grade").value = item.grade;
    document.getElementById("file").value = item.file;
}

function deleteCard(id){
    allData = allData.filter(i=>i.id!==id);
    updateGitHub();
}

function saveCard(){
    const id = document.getElementById("cardId").value;
    const title = document.getElementById("title").value;
    const subject = document.getElementById("subject").value;
    const category = document.getElementById("category").value;
    const grade = document.getElementById("grade").value;
    const file = document.getElementById("file").value;

    if(id){
        const item = allData.find(i=>i.id==id);
        item.title = title;
        item.subject = subject;
        item.category = category;
        item.grade = grade;
        item.file = file;
    }else{
        const newId = Date.now();
        allData.push({id:newId,title,subject,category,grade,file});
    }

    updateGitHub();
}

async function updateGitHub(){
    const token = document.getElementById("token").value;

    const content = btoa(JSON.stringify(allData,null,2));

    await fetch(`https://api.github.com/repos/${repo}/contents/${dataPath}`,{
        method:"PUT",
        headers:{
            "Authorization":"token "+token,
            "Content-Type":"application/json"
        },
        body:JSON.stringify({
            message:"update data.json",
            content:content,
            sha:sha
        })
    });

    alert("บันทึกสำเร็จ");
    loadData();
}

loadData();

</script>

</body>
</html>
