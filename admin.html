<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<title>Admin Panel</title>

<style>
body{
font-family:Arial;
background:#f4f6f9;
margin:0;
padding:20px;
}
h2{margin-top:0}
.card{
background:white;
padding:15px;
margin-bottom:15px;
border-radius:10px;
box-shadow:0 2px 5px rgba(0,0,0,0.1);
}
input,select{
width:100%;
padding:8px;
margin:5px 0;
}
button{
padding:8px 15px;
margin-top:5px;
cursor:pointer;
}
.topbox{
background:white;
padding:15px;
border-radius:10px;
margin-bottom:20px;
}
</style>
</head>
<body>

<h2>üîê Admin Panel</h2>

<div class="topbox">
<input id="token" placeholder="GitHub Token">
<input id="owner" placeholder="Repo Owner">
<input id="repo" placeholder="Repo Name">

<button onclick="initLoad()">Load System</button>
<button onclick="saveData()">Save data.json</button>

<hr>

<h3>üìÇ Upload File</h3>
<input type="file" id="fileUpload">
<button onclick="uploadFile()">Upload to FilesFolder</button>
</div>

<h3>‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà</h3>
<div class="card">

<input id="newTitle" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á">

<select id="newSubject">
<option>‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå</option>
<option>‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</option>
<option>‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå</option>
<option>‡πÄ‡∏Ñ‡∏°‡∏µ</option>
<option>‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤</option>
<option>‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</option>
<option>‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</option>
<option>‡∏™‡∏±‡∏á‡∏Ñ‡∏°</option>
</select>

<select id="newGrade">
<option>‡∏°.1</option>
<option>‡∏°.2</option>
<option>‡∏°.3</option>
<option>‡∏°.4</option>
<option>‡∏°.5</option>
<option>‡∏°.6</option>
</select>

<select id="newFileSelect">
<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå --</option>
</select>

<button onclick="addCard()">Add</button>

</div>

<h3>üìö ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</h3>
<div id="cardList"></div>

<script>

let allData=[];
let dataSHA="";
let fileList=[];

// ===== UTF8 SAFE BASE64 =====
function toBase64UTF8(str){
const bytes=new TextEncoder().encode(str);
let binary="";
bytes.forEach(b=>binary+=String.fromCharCode(b));
return btoa(binary);
}
function fromBase64UTF8(base64){
const binary=atob(base64);
const bytes=Uint8Array.from(binary,c=>c.charCodeAt(0));
return new TextDecoder().decode(bytes);
}

// ===== INIT LOAD =====
async function initLoad(){
await loadFiles();
await loadData();
}

// ===== LOAD FILE LIST =====
async function loadFiles(){

const token=document.getElementById("token").value;
const owner=document.getElementById("owner").value;
const repo=document.getElementById("repo").value;

const res=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/FilesFolder`,{
headers:{Authorization:"token "+token}
});

const data=await res.json();

fileList=data.filter(f=>f.type==="file")
.map(f=>"FilesFolder/"+f.name);

const select=document.getElementById("newFileSelect");
select.innerHTML='<option value="">-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå --</option>';

fileList.forEach(f=>{
select.innerHTML+=`<option value="${f}">
${f.replace("FilesFolder/","")}
</option>`;
});
}

// ===== LOAD DATA.JSON =====
async function loadData(){

const token=document.getElementById("token").value;
const owner=document.getElementById("owner").value;
const repo=document.getElementById("repo").value;

const res=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`,{
headers:{Authorization:"token "+token}
});

const data=await res.json();

allData=JSON.parse(fromBase64UTF8(data.content));
dataSHA=data.sha;

renderCards();
}

// ===== SAVE DATA =====
async function saveData(){

const token=document.getElementById("token").value;
const owner=document.getElementById("owner").value;
const repo=document.getElementById("repo").value;

const jsonString=JSON.stringify(allData,null,2);

await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/data.json`,{
method:"PUT",
headers:{
Authorization:"token "+token,
"Content-Type":"application/json"
},
body:JSON.stringify({
message:"Update data.json via Admin Panel",
content:toBase64UTF8(jsonString),
sha:dataSHA
})
});

alert("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
}

// ===== RENDER CARDS =====
function renderCards(){

const container=document.getElementById("cardList");
container.innerHTML="";

allData.forEach((item,index)=>{

container.innerHTML+=`
<div class="card">

<input value="${item.title}"
onchange="allData[${index}].title=this.value">

<select onchange="allData[${index}].subject=this.value">
${generateOptions(
["‡∏Ñ‡∏ì‡∏¥‡∏ï‡∏®‡∏≤‡∏™‡∏ï‡∏£‡πå","‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô","‡∏ü‡∏¥‡∏™‡∏¥‡∏Å‡∏™‡πå","‡πÄ‡∏Ñ‡∏°‡∏µ","‡∏ä‡∏µ‡∏ß‡∏ß‡∏¥‡∏ó‡∏¢‡∏≤","‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢","‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©","‡∏™‡∏±‡∏á‡∏Ñ‡∏°"],
item.subject
)}
</select>

<select onchange="allData[${index}].grade=this.value">
${generateOptions(
["‡∏°.1","‡∏°.2","‡∏°.3","‡∏°.4","‡∏°.5","‡∏°.6"],
item.grade
)}
</select>

<select onchange="allData[${index}].file=this.value">
${generateOptions(fileList,item.file,true)}
</select>

<button onclick="deleteCard(${index})">‚ùå Delete</button>

</div>
`;
});
}

// ===== GENERATE OPTIONS =====
function generateOptions(array,selected,isFile=false){
let html="";
array.forEach(val=>{
let text=isFile?val.replace("FilesFolder/",""):val;
html+=`<option value="${val}" ${val===selected?"selected":""}>
${text}
</option>`;
});
return html;
}

// ===== ADD =====
function addCard(){

allData.push({
title:document.getElementById("newTitle").value,
subject:document.getElementById("newSubject").value,
category:"-",
grade:document.getElementById("newGrade").value,
file:document.getElementById("newFileSelect").value
});

renderCards();
}

// ===== DELETE =====
function deleteCard(index){
allData.splice(index,1);
renderCards();
}

// ===== UPLOAD FILE =====
async function uploadFile(){

const token=document.getElementById("token").value;
const owner=document.getElementById("owner").value;
const repo=document.getElementById("repo").value;

const fileInput=document.getElementById("fileUpload");
const file=fileInput.files[0];

if(!file){ alert("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Å‡πà‡∏≠‡∏ô"); return; }

const reader=new FileReader();

reader.onload=async function(){

const base64=reader.result.split(",")[1];

await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/FilesFolder/${file.name}`,{
method:"PUT",
headers:{
Authorization:"token "+token,
"Content-Type":"application/json"
},
body:JSON.stringify({
message:"Upload "+file.name,
content:base64
})
});

alert("Upload ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

await loadFiles();

};

reader.readAsDataURL(file);
}

</script>

</body>
</html>
